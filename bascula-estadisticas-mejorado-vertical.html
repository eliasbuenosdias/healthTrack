<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estadísticas de la Báscula</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #4a6fa5;
            --secondary-color: #166088;
            --accent-color: #4cb5f5;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --border-radius: 8px;
            --box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f4f8;
            color: var(--dark-color);
            line-height: 1.6;
            padding: 0;
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 20px 0;
            text-align: center;
            border-bottom: 4px solid var(--accent-color);
            box-shadow: var(--box-shadow);
        }
        
        .header h1 {
            font-size: 2.2rem;
            margin-bottom: 10px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            width: 100%;
        }
        
        .main-content {
            flex: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .card {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 25px;
            margin: 20px 0;
        }
        
        .controls {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .file-input-container {
            position: relative;
            overflow: hidden;
            display: inline-block;
            cursor: pointer;
            width: 100%;
            max-width: 250px;
        }
        
        .file-input-label {
            display: block;
            padding: 12px 20px;
            background-color: var(--primary-color);
            color: white;
            border-radius: var(--border-radius);
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .file-input-label:hover {
            background-color: var(--secondary-color);
        }
        
        .file-input-container input[type="file"] {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        
        select, input[type="date"], button {
            padding: 12px 20px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            background-color: white;
            font-family: inherit;
            font-size: 1rem;
            transition: all 0.3s;
        }
        
        select {
            cursor: pointer;
            min-width: 150px;
        }
        
        select:focus, input:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(76, 181, 245, 0.2);
        }
        
        button {
            background-color: var(--success-color);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
            min-width: 120px;
        }
        
        button:hover {
            background-color: #218838;
            transform: translateY(-2px);
        }
        
        .metrics-selection {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin: 20px 0;
            justify-content: center;
        }
        
        .metrics-groups {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 20px;
            justify-content: center;
        }
        
        .metrics-group {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 15px;
            width: 100%;
            max-width: 250px;
        }
        
        .metrics-group-title {
            color: var(--primary-color);
            margin-bottom: 10px;
            font-weight: 600;
            text-align: center;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }
        
        .metric-checkbox {
            display: flex;
            align-items: center;
            background-color: #f1f3f5;
            padding: 8px 15px;
            border-radius: 50px;
            transition: all 0.2s;
            margin-bottom: 8px;
        }
        
        .metric-checkbox:hover {
            background-color: #e9ecef;
        }
        
        .metric-checkbox input {
            margin-right: 8px;
            cursor: pointer;
        }
        
        .metric-checkbox label {
            cursor: pointer;
            font-weight: 500;
        }
        
        /* Sliding container for charts */
        .charts-slider-container {
            flex: 1;
            position: relative;
            overflow: hidden;
            margin: 0 auto;
            padding: 0 10px;
        }
        
        .charts-container {
            overflow-y: auto;
            max-height: calc(100vh - 300px);
            padding: 10px;
            scrollbar-width: thin;
            scrollbar-color: var(--accent-color) #f0f4f8;
        }
        
        .charts-container::-webkit-scrollbar {
            width: 10px;
        }
        
        .charts-container::-webkit-scrollbar-track {
            background: #f0f4f8;
            border-radius: 10px;
        }
        
        .charts-container::-webkit-scrollbar-thumb {
            background-color: var(--accent-color);
            border-radius: 10px;
            border: 2px solid #f0f4f8;
        }
        
        .chart-wrapper {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 20px;
            height: 400px;
            margin-bottom: 20px;
            position: relative;
        }
        
        .chart-title {
            font-size: 1.2rem;
            color: var(--primary-color);
            margin-bottom: 15px;
            text-align: center;
            font-weight: 600;
            padding-bottom: 5px;
            border-bottom: 1px solid #eee;
        }
        
        .chart-actions {
            position: absolute;
            top: 15px;
            right: 15px;
            display: flex;
            gap: 5px;
        }
        
        .chart-action-btn {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
        }
        
        .chart-action-btn:hover {
            background-color: #e9ecef;
        }
        
        .footer {
            text-align: center;
            padding: 15px 0;
            background-color: var(--light-color);
            border-top: 1px solid #dee2e6;
            color: #6c757d;
            font-size: 0.9rem;
        }
        
        /* Navigation slider */
        .slider-navigation {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px 0;
            background-color: var(--light-color);
            border-top: 1px solid #dee2e6;
        }
        
        .slider-dots {
            display: flex;
            gap: 8px;
        }
        
        .slider-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #dee2e6;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .slider-dot.active {
            background-color: var(--primary-color);
            transform: scale(1.2);
        }
        
        .date-range-info {
            background-color: var(--light-color);
            padding: 8px 15px;
            border-radius: var(--border-radius);
            text-align: center;
            margin: 10px 0;
            font-weight: 500;
            color: var(--secondary-color);
        }
        
        /* Responsive design */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8rem;
            }
            
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .file-input-container {
                max-width: 100%;
            }
            
            .metrics-group {
                max-width: 100%;
            }
            
            .chart-wrapper {
                height: 350px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <h1>Estadísticas de la Báscula</h1>
            <p>Visualiza y analiza tus datos de composición corporal</p>
        </div>
    </div>

    <div class="main-content">
        <div class="container">
            <div class="card">
                <div class="controls">
                    <div class="file-input-container">
                        <label class="file-input-label">Cargar archivo CSV</label>
                        <input type="file" id="fileInput" accept=".csv">
                    </div>
                    
                    <select id="filter">
                        <option value="all">Todos los datos</option>
                        <option value="weekly">Última semana</option>
                        <option value="monthly">Último mes</option>
                        <option value="yearly" selected>Último año</option>
                        <option value="custom">Personalizado</option>
                    </select>
                    
                    <input type="date" id="startDate">
                    <input type="date" id="endDate">
                    
                    <button id="updateButton">Actualizar</button>
                </div>
                
                <div class="metrics-groups">
                    <div class="metrics-group">
                        <div class="metrics-group-title">Composición Principal</div>
                        <div class="metric-checkbox">
                            <input type="checkbox" id="weight" value="weight" checked>
                            <label for="weight">Peso (kg)</label>
                        </div>
                        <div class="metric-checkbox">
                            <input type="checkbox" id="bmi" value="bmi" checked>
                            <label for="bmi">IMC</label>
                        </div>
                    </div>
                    
                    <div class="metrics-group">
                        <div class="metrics-group-title">Grasa y Músculo</div>
                        <div class="metric-checkbox">
                            <input type="checkbox" id="fatRate" value="fatRate" checked>
                            <label for="fatRate">Grasa (%)</label>
                        </div>
                        <div class="metric-checkbox">
                            <input type="checkbox" id="muscleRate" value="muscleRate" checked>
                            <label for="muscleRate">Músculo (%)</label>
                        </div>
                        <div class="metric-checkbox">
                            <input type="checkbox" id="visceralFat" value="visceralFat" checked>
                            <label for="visceralFat">Grasa Visceral</label>
                        </div>
                    </div>
                    
                    <div class="metrics-group">
                        <div class="metrics-group-title">Otros Indicadores</div>
                        <div class="metric-checkbox">
                            <input type="checkbox" id="bodyWaterRate" value="bodyWaterRate" checked>
                            <label for="bodyWaterRate">Agua (%)</label>
                        </div>
                        <div class="metric-checkbox">
                            <input type="checkbox" id="boneMass" value="boneMass" checked>
                            <label for="boneMass">Masa Ósea (kg)</label>
                        </div>
                        <div class="metric-checkbox">
                            <input type="checkbox" id="metabolism" value="metabolism" checked>
                            <label for="metabolism">Metabolismo (kcal)</label>
                        </div>
                    </div>
                </div>
                
                <div id="dateRangeInfo" class="date-range-info">
                    No hay datos cargados
                </div>
            </div>
            
            <div class="charts-slider-container">
                <div id="chartsContainer" class="charts-container">
                    <!-- Charts will be dynamically inserted here -->
                </div>
            </div>
        </div>
    </div>
    
    <div class="footer">
        <div class="container">
            <p>© 2025 Estadísticas de la Báscula | Visualiza tus datos corporales de forma sencilla</p>
        </div>
    </div>

    <script>
        // Chart colors with better visual hierarchy
        const chartColors = {
            weight: { color: '#4a6fa5', background: 'rgba(74, 111, 165, 0.1)' },
            bmi: { color: '#f39c12', background: 'rgba(243, 156, 18, 0.1)' },
            fatRate: { color: '#e74c3c', background: 'rgba(231, 76, 60, 0.1)' },
            bodyWaterRate: { color: '#3498db', background: 'rgba(52, 152, 219, 0.1)' },
            boneMass: { color: '#8e44ad', background: 'rgba(142, 68, 173, 0.1)' },
            metabolism: { color: '#16a085', background: 'rgba(22, 160, 133, 0.1)' },
            muscleRate: { color: '#27ae60', background: 'rgba(39, 174, 96, 0.1)' },
            visceralFat: { color: '#d35400', background: 'rgba(211, 84, 0, 0.1)' }
        };
        
        // Metric titles and units for better readability
        const metricInfo = {
            weight: { title: 'Peso Corporal', unit: 'kg', order: 1 },
            bmi: { title: 'Índice de Masa Corporal', unit: '', order: 2 },
            fatRate: { title: 'Porcentaje de Grasa Corporal', unit: '%', order: 3 },
            muscleRate: { title: 'Porcentaje de Músculo', unit: '%', order: 4 },
            visceralFat: { title: 'Grasa Visceral', unit: '', order: 5 },
            bodyWaterRate: { title: 'Porcentaje de Agua Corporal', unit: '%', order: 6 },
            boneMass: { title: 'Masa Ósea', unit: 'kg', order: 7 },
            metabolism: { title: 'Metabolismo Basal', unit: 'kcal', order: 8 }
        };
        
        let rawData = [];
        let charts = {};
        
        // DOM Elements
        const fileInput = document.getElementById('fileInput');
        const filterSelect = document.getElementById('filter');
        const startDateInput = document.getElementById('startDate');
        const endDateInput = document.getElementById('endDate');
        const updateButton = document.getElementById('updateButton');
        const chartsContainer = document.getElementById('chartsContainer');
        const dateRangeInfo = document.getElementById('dateRangeInfo');
        
        // Event Listeners
        fileInput.addEventListener('change', handleFileUpload);
        updateButton.addEventListener('click', updateCharts);
        filterSelect.addEventListener('change', handleFilterChange);
        
        // Handle filter type change
        function handleFilterChange() {
            const isCustom = filterSelect.value === 'custom';
            startDateInput.style.display = isCustom ? 'block' : 'none';
            endDateInput.style.display = isCustom ? 'block' : 'none';
            
            if (!isCustom && rawData.length > 0) {
                updateCharts();
            }
        }
        
        // Handle file upload
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = e => {
                try {
                    rawData = parseCSV(e.target.result);
                    if (rawData.length > 0) {
                        updateCharts();
                    } else {
                        alert("No se pudieron procesar datos válidos del archivo CSV.");
                        dateRangeInfo.textContent = "No hay datos válidos en el archivo";
                    }
                } catch (error) {
                    console.error("Error processing CSV:", error);
                    alert("Error al procesar el archivo CSV: " + error.message);
                    dateRangeInfo.textContent = "Error al procesar el archivo";
                }
            };
            reader.readAsText(file);
        }
        
        // Parse CSV data
        function parseCSV(csv) {
            const lines = csv.split('\n');
            
            // Skip empty lines
            return lines.filter(line => line.trim() !== '')
                .map(line => {
                    const values = line.split(',').map(v => v.trim());
                    if (values.length < 10) return null; // Skip incomplete lines
                    
                    // Check if this is a header row
                    if (isNaN(parseFloat(values[1]))) return null;
                    
                    const [time, weight, height, bmi, fatRate, bodyWaterRate, boneMass, metabolism, muscleRate, visceralFat] = values;
                    
                    return {
                        time: new Date(time),
                        weight: parseFloat(weight),
                        height: parseFloat(height),
                        bmi: parseFloat(bmi),
                        fatRate: parseFloat(fatRate),
                        bodyWaterRate: parseFloat(bodyWaterRate),
                        boneMass: parseFloat(boneMass),
                        metabolism: parseFloat(metabolism),
                        muscleRate: parseFloat(muscleRate),
                        visceralFat: parseFloat(visceralFat)
                    };
                })
                .filter(entry => entry && !isNaN(entry.time) && !isNaN(entry.weight));
        }
        
        // Filter data based on selected time range
        function filterData() {
            const filterType = filterSelect.value;
            const startDate = new Date(startDateInput.value);
            const endDate = new Date(endDateInput.value);
            endDate.setHours(23, 59, 59); // Include the entire end day
            
            const now = new Date();
            let filteredData;
            
            switch (filterType) {
                case 'weekly':
                    const weekAgo = new Date();
                    weekAgo.setDate(now.getDate() - 7);
                    filteredData = rawData.filter(d => d.time >= weekAgo);
                    break;
                    
                case 'monthly':
                    const monthAgo = new Date();
                    monthAgo.setMonth(now.getMonth() - 1);
                    filteredData = rawData.filter(d => d.time >= monthAgo);
                    break;
                    
                case 'yearly':
                    const yearAgo = new Date();
                    yearAgo.setFullYear(now.getFullYear() - 1);
                    filteredData = rawData.filter(d => d.time >= yearAgo);
                    break;
                    
                case 'custom':
                    if (!isNaN(startDate) && !isNaN(endDate)) {
                        filteredData = rawData.filter(d => d.time >= startDate && d.time <= endDate);
                    } else {
                        filteredData = rawData;
                    }
                    break;
                    
                default: // 'all'
                    filteredData = [...rawData];
            }
            
            // Sort by date
            return filteredData.sort((a, b) => a.time - b.time);
        }
        
        // Create or update charts
        function updateCharts() {
            const data = filterData();
            if (data.length === 0) {
                alert("No hay datos disponibles para el período seleccionado");
                dateRangeInfo.textContent = "No hay datos para el período seleccionado";
                return;
            }
            
            // Format dates for display
            const labels = data.map(d => {
                const date = new Date(d.time);
                return date.toLocaleDateString('es-ES', { 
                    day: '2-digit', 
                    month: '2-digit',
                    year: '2-digit'
                });
            });
            
            // Get selected metrics
            const selectedMetrics = Array.from(document.querySelectorAll('input[type=checkbox]:checked'))
                .map(cb => cb.value)
                .sort((a, b) => metricInfo[a].order - metricInfo[b].order); // Sort by predefined order
            
            // Clear charts container
            chartsContainer.innerHTML = '';
            
            // Destroy existing charts
            Object.values(charts).forEach(chart => {
                if (chart) chart.destroy();
            });
            
            charts = {};
            
            // Create datasets for each metric in order
            selectedMetrics.forEach(metric => {
                const chartWrapper = document.createElement('div');
                chartWrapper.className = 'chart-wrapper';
                chartWrapper.id = `chart-wrapper-${metric}`;
                
                const chartTitle = document.createElement('div');
                chartTitle.className = 'chart-title';
                chartTitle.textContent = metricInfo[metric].title;
                
                const canvas = document.createElement('canvas');
                canvas.id = metric + 'Chart';
                
                chartWrapper.appendChild(chartTitle);
                chartWrapper.appendChild(canvas);
                chartsContainer.appendChild(chartWrapper);
                
                // Get metric data
                const metricData = data.map(d => d[metric]);
                
                // Create chart
                const ctx = canvas.getContext('2d');
                charts[metric] = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: metricInfo[metric].title + (metricInfo[metric].unit ? ` (${metricInfo[metric].unit})` : ''),
                            data: metricData,
                            borderColor: chartColors[metric].color,
                            backgroundColor: chartColors[metric].background,
                            borderWidth: 3,
                            pointRadius: 4,
                            pointHoverRadius: 6,
                            tension: 0.2,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return context.raw.toFixed(1) + (metricInfo[metric].unit ? ` ${metricInfo[metric].unit}` : '');
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                grid: {
                                    display: false
                                }
                            },
                            y: {
                                beginAtZero: metric === 'visceralFat' ? true : false,
                                suggestedMin: getMinValue(metricData, 0.9),
                                suggestedMax: getMaxValue(metricData, 1.1)
                            }
                        }
                    }
                });
            });
            
            // Update date range info
            updateDateRangeSummary(data);
            
            // Scroll to top of charts container
            chartsContainer.scrollTop = 0;
        }
        
        // Calculate appropriate min value for chart (to avoid excessive white space)
        function getMinValue(data, factor) {
            const min = Math.min(...data);
            return min * factor;
        }
        
        // Calculate appropriate max value for chart
        function getMaxValue(data, factor) {
            const max = Math.max(...data);
            return max * factor;
        }
        
        // Display date range summary
        function updateDateRangeSummary(data) {
            if (data.length === 0) return;
            
            const firstDate = new Date(data[0].time);
            const lastDate = new Date(data[data.length - 1].time);
            
            const dateOptions = { day: '2-digit', month: 'short', year: 'numeric' };
            const firstDateStr = firstDate.toLocaleDateString('es-ES', dateOptions);
            const lastDateStr = lastDate.toLocaleDateString('es-ES', dateOptions);
            
            dateRangeInfo.textContent = `Mostrando datos desde ${firstDateStr} hasta ${lastDateStr} (${data.length} mediciones)`;
        }
        
        // Initialize date inputs
        function initializeDateInputs() {
            const today = new Date();
            const lastYear = new Date();
            lastYear.setFullYear(today.getFullYear() - 1);
            
            endDateInput.valueAsDate = today;
            startDateInput.valueAsDate = lastYear;
            
            // Initially hide date inputs unless custom filter is selected
            handleFilterChange();
        }
        
        // Initialize on page load
        window.onload = function() {
            initializeDateInputs();
            
            // Check if user has previously uploaded data (for demo purposes)
            if (localStorage.getItem('hasData') === 'true') {
                dateRangeInfo.textContent = "Selecciona un archivo CSV para comenzar";
            }
        };
    </script>
</body>
</html>
