<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HealthTrack - Dashboard de Salud</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* Estilos omitidos por brevedad */
    </style>
    <!-- Línea para cargar el archivo JavaScript externo -->
    <script>
        let allData = [];
        let filteredData = [];
        let weightChart, bmiChart, fatRateChart, muscleRateChart, waterRateChart, metabolismChart, visceralFatChart, boneMassChart;
        let currentFilterType = 'all';
        let customStartDate = null;
        let customEndDate = null;

        const healthRanges = {
            bmi: { min: 18.5, max: 24.9 },
            fatRate: { min: 10, max: 20 },
            muscleRate: { min: 40, max: 60 },
            bodyWaterRate: { min: 50, max: 65 },
            visceralFat: { min: 1, max: 9 }
        };

        document.addEventListener('DOMContentLoaded', function() {
            const sidebar = document.getElementById('sidebar');
            const toggleSidebarBtn = document.getElementById('toggleSidebar');
            const mainContent = document.getElementById('mainContent');
            const presetFilters = document.querySelectorAll('.preset-filter');
            const startDateInput = document.getElementById('startDate');
            const endDateInput = document.getElementById('endDate');
            const applyCustomFilterBtn = document.getElementById('applyCustomFilter');
            const dateRangeDisplay = document.getElementById('dateRangeDisplay');
            const csvFileInput = document.getElementById('csvFileInput');
            const loadDataBtn = document.getElementById('loadDataBtn');
            const dataSection = document.getElementById('data-section');

            toggleSidebarBtn.addEventListener('click', () => {
                sidebar.classList.toggle('collapsed');
                mainContent.classList.toggle('expanded');
            });

            presetFilters.forEach(filter => {
                filter.addEventListener('click', function() {
                    const filterType = this.getAttribute('data-filter');
                    applyFilter(filterType);
                    presetFilters.forEach(f => f.classList.remove('active'));
                    this.classList.add('active');
                    updateDateRangeDisplay(filterType);
                });
            });

            applyCustomFilterBtn.addEventListener('click', () => {
                const startDate = new Date(startDateInput.value);
                const endDate = new Date(endDateInput.value);
                if (startDate && endDate) {
                    customStartDate = startDate;
                    customEndDate = endDate;
                    applyFilter('custom');
                    presetFilters.forEach(f => f.classList.remove('active'));
                    document.querySelector('[data-filter="custom"]').classList.add('active');
                    updateDateRangeDisplay('custom');
                }
            });

            loadDataBtn.addEventListener('click', () => {
                const file = csvFileInput.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const content = e.target.result;
                        parseVerticalCSV(content);
                        if (allData.length > 0) {
                            initializeCharts();
                            applyFilter('all');
                            document.querySelector('[data-filter="all"]').classList.add('active');
                            updateDateRangeDisplay('all');
                            dataSection.style.display = 'block';
                        }
                    };
                    reader.readAsText(file);
                }
            });
        });

        function parseVerticalCSV(content) {
            const lines = content.trim().split('\n');
            const headers = [];
            const values = [];

            let headerSection = true;

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();

                if (line.match(/^\*?\*?\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}\+\d{4}\*?\*?$/)) {
                    headerSection = false;
                }

                if (headerSection) {
                    if (line && !line.match(/^\*\*\s*\*\*$/)) {
                        headers.push(line.replace(/\*\*/g, '').trim());
                    }
                } else {
                    values.push(line.replace(/\*\*/g, '').trim());
                }
            }

            if (headers.length > 0 && values.length > 0) {
                const dataPoint = {};

                for (let i = 0; i < Math.min(headers.length, values.length); i++) {
                    const header = headers[i].replace(/\*\*/g, '').trim();
                    const value = values[i].replace(/\*\*/g, '').trim();

                    if (header === 'time') {
                        try {
                            dataPoint[header] = new Date(value);
                            if (isNaN(dataPoint[header].getTime())) {
                                console.error("Error en formato de fecha:", value);
                                dataPoint[header] = value;
                            }
                        } catch (e) {
                            console.error("Error al parsear fecha:", e);
                            dataPoint[header] = value;
                        }
                    } else {
                        const numValue = parseFloat(value);
                        dataPoint[header] = !isNaN(numValue) ? numValue : value;
                    }
                }

                if (dataPoint.time && dataPoint.weight) {
                    allData.push(dataPoint);
                    console.log("Datos cargados:", allData);
                } else {
                    console.error("Datos incompletos o inválidos:", dataPoint);
                }
            }
        }

        function applyFilter(filterType) {
            currentFilterType = filterType;
            const now = new Date();

            switch(filterType) {
                case 'week':
                    const oneWeekAgo = new Date();
                    oneWeekAgo.setDate(now.getDate() - 7);
                    filteredData = allData.filter(item => {
                        const itemDate = item.time instanceof Date ? item.time : new Date(item.time);
                        return itemDate >= oneWeekAgo;
                    });
                    break;
                case 'month':
                    const oneMonthAgo = new Date();
                    oneMonthAgo.setMonth(now.getMonth() - 1);
                    filteredData = allData.filter(item => {
                        const itemDate = item.time instanceof Date ? item.time : new Date(item.time);
                        return itemDate >= oneMonthAgo;
                    });
                    break;
                case 'year':
                    const oneYearAgo = new Date();
                    oneYearAgo.setFullYear(now.getFullYear() - 1);
                    filteredData = allData.filter(item => {
                        const itemDate = item.time instanceof Date ? item.time : new Date(item.time);
                        return itemDate >= oneYearAgo;
                    });
                    break;
                case 'custom':
                    if (customStartDate && customEndDate) {
                        filteredData = allData.filter(item => {
                            const itemDate = item.time instanceof Date ? item.time : new Date(item.time);
                            return itemDate >= customStartDate && itemDate <= customEndDate;
                        });
                    }
                    break;
                case 'all':
                default:
                    filteredData = [...allData];
                    break;
            }

            updateCharts();
        }

        function updateDateRangeDisplay(filterType) {
            const dateRangeDisplay = document.getElementById('dateRangeDisplay');
            const now = new Date();
            let text = '';

            switch(filterType) {
                case 'week':
                    const oneWeekAgo = new Date();
                    oneWeekAgo.setDate(now.getDate() - 7);
                    text = `Datos de la última semana (${formatDate(oneWeekAgo)} - ${formatDate(now)})`;
                    break;
                case 'month':
                    const oneMonthAgo = new Date();
                    oneMonthAgo.setMonth(now.getMonth() - 1);
                    text = `Datos del último mes (${formatDate(oneMonthAgo)} - ${formatDate(now)})`;
                    break;
                case 'year':
                    const oneYearAgo = new Date();
                    oneYearAgo.setFullYear(now.getFullYear() - 1);
                    text = `Datos del último año (${formatDate(oneYearAgo)} - ${formatDate(now)})`;
                    break;
                case 'custom':
                    if (customStartDate && customEndDate) {
                        text = `Rango personalizado (${formatDate(customStartDate)} - ${formatDate(customEndDate)})`;
                    } else {
                        text = 'Rango personalizado (seleccione fechas)';
                    }
                    break;
                case 'all':
                default:
                    if (allData.length > 0) {
                        const dates = allData.map(item => {
                            return item.time instanceof Date ? item.time : new Date(item.time);
                        });
                        const minDate = new Date(Math.min(...dates.map(d => d.getTime())));
                        const maxDate = new Date(Math.max(...dates.map(d => d.getTime())));
                        text = `Todos los datos (${formatDate(minDate)} - ${formatDate(maxDate)})`;
                    } else {
                        text = 'Todos los datos';
                    }
                    break;
            }

            dateRangeDisplay.textContent = text;
        }

        function formatDate(date) {
            return date.toLocaleDateString();
        }

        function initializeCharts() {
            const ctx = {
                weight: document.getElementById('weightChart').getContext('2d'),
                bmi: document.getElementById('bmiChart').getContext('2d'),
                fatRate: document.getElementById('fatRateChart').getContext('2d'),
                muscleRate: document.getElementById('muscleRateChart').getContext('2d'),
                waterRate: document.getElementById('waterRateChart').getContext('2d'),
                metabolism: document.getElementById('metabolismChart').getContext('2d'),
                visceralFat: document.getElementById('visceralFatChart').getContext('2d'),
                boneMass: document.getElementById('boneMassChart').getContext('2d')
            };

            const commonConfig = {
                type: 'line',
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'day'
                            }
                        }
                    }
                }
            };

            weightChart = createChart(ctx.weight, 'Peso (kg)', 'weight', commonConfig, null);
            bmiChart = createChart(ctx.bmi, 'IMC', 'bmi', commonConfig, healthRanges.bmi);
            fatRateChart = createChart(ctx.fatRate, 'Grasa Corporal (%)', 'fatRate', commonConfig, healthRanges.fatRate);
            muscleRateChart = createChart(ctx.muscleRate, 'Masa Muscular (%)', 'muscleRate', commonConfig, healthRanges.muscleRate);
            waterRateChart = createChart(ctx.waterRate, 'Agua Corporal (%)', 'bodyWaterRate', commonConfig, healthRanges.bodyWaterRate);
            metabolismChart = createChart(ctx.metabolism, 'Metabolismo (kcal)', 'metabolism', commonConfig, null);
            visceralFatChart = createChart(ctx.visceralFat, 'Grasa Visceral', 'visceralFat', commonConfig, healthRanges.visceralFat);
            boneMassChart = createChart(ctx.boneMass, 'Masa Ósea (kg)', 'boneMass', commonConfig, null);
        }

        function createChart(ctx, label, dataKey, commonConfig, healthRange) {
            const config = JSON.parse(JSON.stringify(commonConfig));

            config.data = {
                labels: filteredData.map(item => item.time),
                datasets: [{
                    label: label,
                    data: filteredData.map(item => ({ x: item.time, y: item[dataKey] })),
                    borderColor: 'rgba(75, 192, 192, 1)',
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    borderWidth: 2,
                    fill: true
                }]
            };

            if (healthRange) {
                config.data.datasets.push({
                    label: 'Mínimo saludable',
                    data: filteredData.map(item => ({ x: item.time, y: healthRange.min })),
                    borderColor: 'rgba(255, 99, 132, 1)',
                    borderWidth: 1,
                    borderDash: [5, 5],
                    fill: false,
                    pointRadius: 0
                });

                config.data.datasets.push({
                    label: 'Máximo saludable',
                    data: filteredData.map(item => ({ x: item.time, y: healthRange.max })),
                    borderColor: 'rgba(255, 99, 132, 1)',
                    borderWidth: 1,
                    borderDash: [5, 5],
                    fill: false,
                    pointRadius: 0
                });
            }

            return new Chart(ctx, config);
        }

        function updateCharts() {
            const charts = [
                { chart: weightChart, key: 'weight' },
                { chart: bmiChart, key: 'bmi' },
                { chart: fatRateChart, key: 'fatRate' },
                { chart: muscleRateChart, key: 'muscleRate' },
                { chart: waterRateChart, key: 'bodyWaterRate' },
                { chart: metabolismChart, key: 'metabolism' },
                { chart: visceralFatChart, key: 'visceralFat' },
                { chart: boneMassChart, key: 'boneMass' }
            ];

            charts.forEach(item => {
                if (item.chart) {
                    item.chart.data.labels = filteredData.map(d => d.time);
                    item.chart.data.datasets[0].data = filteredData.map(d => ({ x: d.time, y: d[item.key] }));

                    if (item.chart.data.datasets.length > 1) {
                        item.chart.data.datasets[1].data = filteredData.map(d => ({ x: d.time, y: item.chart.data.datasets[1].data[0].y }));
                        item.chart.data.datasets[2].data = filteredData.map(d => ({ x: d.time, y: item.chart.data.datasets[2].data[0].y }));
                    }

                    item.chart.update();
                }
            });

            updateStatistics();
        }

        function updateStatistics() {
            if (filteredData.length === 0) return;

            const stats = {
                weight: calculateStats(filteredData.map(item => item.weight)),
                bmi: calculateStats(filteredData.map(item => item.bmi)),
                fatRate: calculateStats(filteredData.map(item => item.fatRate)),
                muscleRate: calculateStats(filteredData.map(item => item.muscleRate)),
                bodyWaterRate: calculateStats(filteredData.map(item => item.bodyWaterRate)),
                metabolism: calculateStats(filteredData.map(item => item.metabolism)),
                visceralFat: calculateStats(filteredData.map(item => item.visceralFat)),
                boneMass: calculateStats(filteredData.map(item => item.boneMass))
            };

            for (const [key, value] of Object.entries(stats)) {
                const avgElement = document.getElementById(`${key}Avg`);
                const minElement = document.getElementById(`${key}Min`);
                const maxElement = document.getElementById(`${key}Max`);

                if (avgElement) avgElement.textContent = value.avg.toFixed(1);
                if (minElement) minElement.textContent = value.min.toFixed(1);
                if (maxElement) maxElement.textContent = value.max.toFixed(1);
            }
        }

        function calculateStats(data) {
            const avg = data.reduce((sum, val) => sum + val, 0) / data.length;
            const min = Math.min(...data);
            const max = Math.max(...data);

            return { avg, min, max };
        }
    </script>
</head>
<body>
    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="logo">
                <i class="fas fa-heartbeat"></i>
                HealthTrack
            </div>
            
            <div class="filter-section">
                <h3>Filtros de Tiempo</h3>
                <button class="preset-filter active" data-filter="all">
                    <i class="fas fa-calendar"></i> Todos los datos
                </button>
                <button class="preset-filter" data-filter="week">
                    <i class="fas fa-calendar-week"></i> Última semana
                </button>
                <button class="preset-filter" data-filter="month">
                    <i class="fas fa-calendar-alt"></i> Último mes
                </button>
                <button class="preset-filter" data-filter="year">
                    <i class="fas fa-calendar-day"></i> Último año
                </button>
            </div>
            
            <div class="filter-section">
                <h3>Rango Personalizado</h3>
                <div class="filter-group">
                    <label for="startDate">Fecha inicial</label>
                    <input type="date" id="startDate" class="filter-input">
                </div>
                <div class="filter-group">
                    <label for="endDate">Fecha final</label>
                    <input type="date" id="endDate" class="filter-input">
                </div>
                <button id="applyCustomFilter" class="filter-btn">
                    <i class="fas fa-filter"></i> Aplicar Filtro
                </button>
            </div>
        </div>
        
        <!-- Toggle Sidebar Button -->
        <button class="toggle-sidebar" id="toggleSidebar">
            <i class="fas fa-bars"></i>
        </button>
        
        <!-- Main Content -->
        <div class="main-content" id="mainContent">
            <header>
                <div class="header-title">Dashboard de Salud</div>
                <div class="user-info">
                    <div class="user-avatar">U</div>
                    <div class="user-name">Usuario</div>
                </div>
            </header>
            
            <div class="file-input-section">
                <div class="file-input-label">
                    <i class="fas fa-file-csv"></i> Cargar datos desde archivo CSV
                </div>
                <div class="file-input-container">
                    <input type="file" id="csvFileInput" class="csv-input" accept=".csv">
                    <button id="loadDataBtn" class="load-btn">
                        <i class="fas fa-upload"></i> Cargar Datos
                    </button>
                </div
